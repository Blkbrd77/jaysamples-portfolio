---
// ChatWidget - A floating chat button that opens a Claude-powered assistant
---

<div id="chat-widget">
  <!-- Chat Toggle Button -->
  <button
    id="chat-toggle"
    class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-300 z-50"
    aria-label="Open chat"
  >
    <svg id="chat-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
    </svg>
    <svg id="close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
  </button>

  <!-- Chat Window -->
  <div
    id="chat-window"
    class="fixed bottom-24 right-6 w-80 sm:w-96 bg-white rounded-xl shadow-2xl border border-slate-200 z-50 flex flex-col max-h-[500px] hidden"
  >
    <!-- Header -->
    <div class="bg-blue-600 text-white px-4 py-3 rounded-t-xl">
      <h3 class="font-semibold">Chat with Jay's AI Assistant</h3>
      <p class="text-xs text-blue-200">Ask about my experience & skills</p>
    </div>

    <!-- Messages -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 min-h-[200px] max-h-[300px]">
      <div class="bg-slate-100 rounded-lg p-3 text-sm text-slate-700">
        Hi! I'm Jay's AI assistant. Ask me anything about his professional experience, skills, or background.
      </div>
    </div>

    <!-- Rate Limit Notice -->
    <div id="rate-limit-notice" class="px-4 py-2 bg-slate-50 text-xs text-slate-500 border-t border-slate-200">
      <span id="messages-remaining">15</span>/15 questions remaining today
    </div>

    <!-- Input -->
    <div class="p-3 border-t border-slate-200">
      <form id="chat-form" class="flex gap-2">
        <input
          type="text"
          id="chat-input"
          placeholder="Type your question..."
          maxlength="500"
          class="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
        <button
          type="submit"
          id="chat-submit"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          Send
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const DAILY_LIMIT = 15;
  const STORAGE_KEY = 'jay_chat_usage';

  // Get or initialize usage data
  function getUsage() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      const data = JSON.parse(stored);
      const today = new Date().toDateString();
      if (data.date === today) {
        return data;
      }
    }
    return { date: new Date().toDateString(), count: 0 };
  }

  function saveUsage(usage: { date: string; count: number }) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(usage));
  }

  function updateRateLimitDisplay() {
    const usage = getUsage();
    const remaining = Math.max(0, DAILY_LIMIT - usage.count);
    const remainingEl = document.getElementById('messages-remaining');
    if (remainingEl) {
      remainingEl.textContent = remaining.toString();
    }
    return remaining;
  }

  // Toggle chat window
  const toggle = document.getElementById('chat-toggle');
  const chatWindow = document.getElementById('chat-window');
  const chatIcon = document.getElementById('chat-icon');
  const closeIcon = document.getElementById('close-icon');

  toggle?.addEventListener('click', () => {
    chatWindow?.classList.toggle('hidden');
    chatIcon?.classList.toggle('hidden');
    closeIcon?.classList.toggle('hidden');
  });

  // Handle form submission
  const form = document.getElementById('chat-form') as HTMLFormElement;
  const input = document.getElementById('chat-input') as HTMLInputElement;
  const messages = document.getElementById('chat-messages');
  const submit = document.getElementById('chat-submit') as HTMLButtonElement;

  function addMessage(content: string, isUser: boolean) {
    const div = document.createElement('div');
    div.className = isUser
      ? 'bg-blue-600 text-white rounded-lg p-3 text-sm ml-8'
      : 'bg-slate-100 rounded-lg p-3 text-sm text-slate-700 mr-8';
    div.textContent = content;
    messages?.appendChild(div);
    messages?.scrollTo(0, messages.scrollHeight);
  }

  function addLoadingIndicator() {
    const div = document.createElement('div');
    div.id = 'loading-indicator';
    div.className = 'bg-slate-100 rounded-lg p-3 text-sm text-slate-500 mr-8';
    div.innerHTML = '<span class="animate-pulse">Thinking...</span>';
    messages?.appendChild(div);
    messages?.scrollTo(0, messages.scrollHeight);
  }

  function removeLoadingIndicator() {
    document.getElementById('loading-indicator')?.remove();
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    // Check rate limit
    const remaining = updateRateLimitDisplay();
    if (remaining <= 0) {
      addMessage('You\'ve reached your daily limit. Please come back tomorrow!', false);
      return;
    }

    // Update usage
    const usage = getUsage();
    usage.count++;
    saveUsage(usage);
    updateRateLimitDisplay();

    // Add user message
    addMessage(message, true);
    input.value = '';
    submit.disabled = true;
    addLoadingIndicator();

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });

      const data = await response.json();
      removeLoadingIndicator();

      if (data.error) {
        addMessage(data.error, false);
      } else {
        addMessage(data.response, false);
      }
    } catch (error) {
      removeLoadingIndicator();
      addMessage('Sorry, something went wrong. Please try again.', false);
    } finally {
      submit.disabled = false;
      input.focus();
    }
  });

  // Initialize
  updateRateLimitDisplay();

  // Auto-open chat only on homepage
  const isHomepage = window.location.pathname === '/' || window.location.pathname === '';
  if (isHomepage && chatWindow && chatIcon && closeIcon) {
    chatWindow.classList.remove('hidden');
    chatIcon.classList.add('hidden');
    closeIcon.classList.remove('hidden');
  }
</script>
